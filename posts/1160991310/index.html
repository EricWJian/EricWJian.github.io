<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>K8S 使用 | Eric</title><meta name="author" content="Eric"><meta name="copyright" content="Eric"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kubernetes官网:https:&amp;#x2F;&amp;#x2F;kubernetes.io&amp;#x2F;zh-cn&amp;#x2F; 第一章 初识 Kubernetes Kubernetes 简介 为什么需要 Kubernetes Kubernetes 能做什么  Kubernetes 不是什么?  1、简介 摘取官网: https:&amp;#x2F;&amp;#x2F;kube"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://ericwjian.github.io/posts/1160991310/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4dfa2c883c8c4c23f4866185de932236";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'K8S 使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-21 09:23:51'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">140</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">98</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Eric"><span class="site-name">Eric</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">K8S 使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-07T16:00:00.000Z" title="发表于 2023-02-08 00:00:00">2023-02-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-21T01:23:51.824Z" title="更新于 2023-09-21 09:23:51">2023-09-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/K8s/">K8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="K8S 使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><hr>
<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><p>官网:<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/">https://kubernetes.io/zh-cn/</a></p>
<h2 id="第一章-初识-Kubernetes"><a href="#第一章-初识-Kubernetes" class="headerlink" title="第一章 初识 Kubernetes"></a>第一章 初识 Kubernetes</h2><ul>
<li>Kubernetes 简介</li>
<li>为什么需要 Kubernetes</li>
<li>Kubernetes 能做什么 </li>
<li>Kubernetes 不是什么?</li>
</ul>
<h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><blockquote>
<p>摘取官网: <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/">https://kubernetes.io/zh-cn/docs/concepts/overview/</a></p>
</blockquote>
<p>Kubernetes这个名字源于希腊语，意为<code>舵手</code>或<code>飞行员</code>。k8s 这个缩写是因为k和s之间有八个字符的关系。Google 在2814 年开源了Kubernetes 项目。Kubernetes建立在Google 大规模运行生产工作负载十几年经验的基础上，结合了社区中最优秀的想法和实践。</p>
<img src="/posts/1160991310/image-20230210203757669.png" class="" title="image-20230210203757669">
<p>Kubernetes 是一个可移植、可扩展的开源平台，用于<code>管理容器化的工作负载和服务，可促进声明式配置和自动化</code>。Kubernetes 拥有一个庞大且快速增长的生态，其服务、支持和工具的使用范围相当广泛。</p>
<p>从 2014 年第一个版本发布以来，Kuberetes迅速获得开源社区的追捧，包括Red Hat、VMware 在内的很多有影响力的公司加入到开发和推广的阵营，目前 Kubernetes 已经成为发展最快、市场占有率最高的容器编排引擎产品。</p>
<h3 id="2、为什么需要-k8s"><a href="#2、为什么需要-k8s" class="headerlink" title="2、为什么需要 k8s"></a>2、为什么需要 k8s</h3><blockquote>
<p>摘取官网：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/">https://kubernetes.io/zh-cn/docs/concepts/overview/</a></p>
</blockquote>
<img src="/posts/1160991310/image-20230210210211613.png" class="" title="image-20230210210211613">

<p><strong>传统部署时代：</strong></p>
<p>早期，各个组织是在物理服务器上运行应用程序。 <code>由于无法限制在物理服务器中运行的应用程序资源使用，因此会导致资源分配问题</code>。 例如，如果在同一台物理服务器上运行多个应用程序， 则可能会出现一个应用程序占用大部分资源的情况，而导致其他应用程序的性能下降。 一种解决方案是将每个应用程序都运行在不同的物理服务器上， 但是当某个应用程式资源利用率不高时，剩余资源无法被分配给其他应用程式， 而且维护许多物理服务器的成本很高。</p>
<p><strong>虚拟化部署时代：</strong></p>
<p>因此，虚拟化技术被引入了。虚拟化技术允许你在单个物理服务器的 CPU 上运行多台虚拟机（VM）。 <code>虚拟化能使应用程序在不同 VM 之间被彼此隔离，且能提供一定程度的安全性， 因为一个应用程序的信息不能被另一应用程序随意访问</code>。</p>
<p>虚拟化技术能够更好地利用物理服务器的资源，并且因为可轻松地添加或更新应用程序， 而因此可以具有更高的可扩缩性，以及降低硬件成本等等的好处。 通过虚拟化，你可以将一组物理资源呈现为可丢弃的虚拟机集群。</p>
<p><code>每个 VM 是一台完整的计算机，在虚拟化硬件之上运行所有组件，包括其自己的操作系统</code>。</p>
<p><strong>容器部署时代：</strong><br>容器类似于VM，但是更宽松的隔离特性，使容器之间可以共享操作系统（O$)。因此，容器比起VM被认为是更轻量级的。且与VW类似，每个容器都具有自己的文件系统、CPIU、内存、进程空间等。由于它们与基础架构分离，因此可以跨云和OS发行版本进行移植。<code>容器的出现解决了应用和基础环境异构的问题，让应用可以做到一次构建，多次部署</code>。不可否认容器是打包和运行应用程序的好方式，因此容器方式部署变得流行起来。但随着容器部署流行，仅仅是基于容器的部署仍有一些问题没有解决:</p>
<ul>
<li>生产环境中，你需要管理运行着应用程序的容器，并确保服务不会下线。例如，如果一个容器发生故障，则你需要启动另一个容器。</li>
<li>高并发时，你需要启动多个成用程序容器为系统提高高可用，并保证多个容器能负载均衡。</li>
<li>在维护、升级版本时，你需要将运行应用程序容器从新部署，部署时必须对之前应用容器备份，一旦出现错误，需要手动启动之前容器保证系统运行。</li>
</ul>
<p><code>如果以上行为交由给系统处理，是不是会更容易一些?那么谁能做到这些?</code></p>
<h3 id="3、Kubernetes，它能做什么"><a href="#3、Kubernetes，它能做什么" class="headerlink" title="3、Kubernetes，它能做什么"></a>3、Kubernetes，它能做什么</h3><blockquote>
<p>摘取官网：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/">https://kubernetes.io/zh-cn/docs/concepts/overview/</a></p>
</blockquote>
<p>这就是 Kubernetes 要来做的事情！ Kubernetes 为你提供了一个可弹性运行分布式系统的框架。 Kubernetes 会满足你的扩展要求、故障转移你的应用、提供部署模式等。Kubernetes 为你提供：</p>
<ul>
<li><p><strong>服务发现和负载均衡</strong></p>
<p>Kubernetes 可以使用 DNS 名称或自己的 IP 地址来暴露容器。 如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p>
</li>
<li><p><strong>存储编排</strong></p>
<p>Kubernetes 允许你自动挂载你选择的存储系统，例如本地存储、公共云提供商等。</p>
</li>
<li><p><strong>自动部署和回滚</strong></p>
<p>你可以使用 Kubernetes 描述已部署容器的所需状态， 它可以以受控的速率将实际状态更改为期望状态。 例如，你可以自动化 Kubernetes 来为你的部署创建新容器， 删除现有容器并将它们的所有资源用于新容器。</p>
</li>
<li><p><strong>自动完成装箱计算</strong></p>
<p>你为 Kubernetes 提供许多节点组成的集群，在这个集群上运行容器化的任务。 你告诉 Kubernetes 每个容器需要多少 CPU 和内存 (RAM)。 Kubernetes 可以将这些容器按实际情况调度到你的节点上，以最佳方式利用你的资源。</p>
</li>
<li><p><strong>自我修复</strong></p>
<p>Kubernetes 将重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器， 并且在准备好服务之前不将其通告给客户端。</p>
</li>
<li><p><strong>密钥与配置管理</strong></p>
<p>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。 你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p>
</li>
</ul>
<h3 id="4、Kubernetes-不是什么"><a href="#4、Kubernetes-不是什么" class="headerlink" title="4、Kubernetes 不是什么"></a>4、Kubernetes 不是什么</h3><blockquote>
<p>摘取官网：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/">https://kubernetes.io/zh-cn/docs/concepts/overview/</a></p>
</blockquote>
<p>Kubernetes 不是传统的、包罗万象的 PaaS（平台即服务）系统。 由于 Kubernetes 是在容器级别运行，而非在硬件级别，它提供了 PaaS 产品共有的一些普遍适用的功能， 例如部署、扩展、负载均衡，允许用户集成他们的日志记录、监控和警报方案。 但是，Kubernetes 不是单体式（monolithic）系统，那些默认解决方案都是可选、可插拔的。 Kubernetes 为构建开发人员平台提供了基础，但是在重要的地方保留了用户选择权，能有更高的灵活性。</p>
<p>Kubernetes：</p>
<ul>
<li><p>不限制支持的应用程序类型。 Kubernetes 旨在支持极其多种多样的工作负载，包括无状态、有状态和数据处理工作负载。 如果应用程序可以在容器中运行，那么它应该可以在 Kubernetes 上很好地运行。</p>
</li>
<li><p>不部署源代码，也不构建你的应用程序。 持续集成（CI）、交付和部署（CI/CD）工作流取决于组织的文化和偏好以及技术要求。</p>
</li>
<li><p>不提供应用程序级别的服务作为内置服务，例如中间件（例如消息中间件）、 数据处理框架（例如 Spark）、数据库（例如 MySQL）、缓存、集群存储系统 （例如 Ceph）。这样的组件可以在 Kubernetes 上运行，并且/或者可以由运行在 Kubernetes 上的应用程序通过可移植机制（例如<a target="_blank" rel="noopener" href="https://openservicebrokerapi.org/">开放服务代理</a>）来访问。</p>
</li>
<li><p>不是日志记录、监视或警报的解决方案。 它集成了一些功能作为概念证明，并提供了收集和导出指标的机制。</p>
</li>
<li><p>不提供也不要求配置用的语言、系统（例如 jsonnet），它提供了声明性 API， 该声明性 API 可以由任意形式的声明性规范所构成。</p>
</li>
<li><p>不提供也不采用任何全面的机器配置、维护、管理或自我修复系统。</p>
</li>
<li><p>此外，Kubernetes 不仅仅是一个编排系统，实际上它消除了编排的需要。 编排的技术定义是执行已定义的工作流程：首先执行 A，然后执行 B，再执行 C。 而 Kubernetes 包含了一组独立可组合的控制过程，可以连续地将当前状态驱动到所提供的预期状态。 你不需要在乎如何从 A 移动到 C，也不需要集中控制，这使得系统更易于使用且功能更强大、 系统更健壮，更为弹性和可扩展。</p>
</li>
</ul>
<h2 id="第二章-组件-amp-架构"><a href="#第二章-组件-amp-架构" class="headerlink" title="第二章 组件&amp;架构"></a>第二章 组件&amp;架构</h2><ul>
<li>集群组件</li>
<li>核心概念</li>
<li>集群安装</li>
</ul>
<h3 id="1、集群组件"><a href="#1、集群组件" class="headerlink" title="1、集群组件"></a>1、集群组件</h3><ul>
<li>集群cluster：将同一个软件服务多个节点组织到一起共同为系统提供服务过程称之为该软件的集群。</li>
<li>k8s 集群： 1.master节点/K8S称为：control plane控制节点，2. work node: 工作节点（pod 容器：应用程序容器）</li>
<li>一个 pod 包含多个 容器。</li>
</ul>
<p>当部署完 Kubernetes，便拥有了一个完整的集群。一组工作机器，称为节点，会运行容器化应用程序。<code>每个集群至少有一个工作节点</code>。工作节点会托<code>管Pod</code> ,而 Pod就是作为应用负载的组件。<code>控制平面管理集群中的工作节点和Pod</code> 。</p>
<img src="/posts/1160991310/image-20230210212618911.png" class="" title="image-20230210212618911">

<h4 id="1-1-控制平面组件-Control-Plane-Components"><a href="#1-1-控制平面组件-Control-Plane-Components" class="headerlink" title="1.1 控制平面组件(Control Plane Components)"></a>1.1 控制平面组件(Control Plane Components)</h4><p>控制平面组件会为集群做出全局决策，比如<code>资源的调度以及检测和响应集群事件。例如当不满足部署的replicas 字段时,要启动新的pod</code> 。</p>
<blockquote>
<p>控制平面组件可以在集群中的任何节点上运行。然而，为了简单起见，设置脚本通常会在同一个计算机上启动所有控制平面组件，并且不会在此计算机上运行用户容器。</p>
</blockquote>
<ul>
<li><p>kube-apiserver(总入口，接收命令)<br>API server 是 Kubernetes 控制平面的组件，<code>该组件负责公开了Kubernetes API，负责处理接受请求的工作</code>。API server是 Kubernetes控制平面的前端。Kubernetes API服务器的主要实现是 kube-apiserver。<code>kube-apiserver</code> 设计上考虑了水平扩缩，也就是说，它可通过部署多个实例来进行扩缩。你可以运行 kube-apiserver 的多个实例，并在这些实例之间平衡流量。</p>
</li>
<li><p>etcd(<code>记录集群数据</code>)</p>
<p><code>一致且高度可用的键值存储，用作 Kubernetes的所有集群数据的后台数据库。</code></p>
</li>
<li><p>kube-scheduler<br><code>kube-scheduler</code>是控制平面的组件，负责监视新创建的、未指定运行节点node 的 Pods，并选择节点来让Pod在上面运行。调度决策考虑的因素包括单个Pod及 Pods集合的资源需求、软硬件及策略约束、亲和性及反亲和性规范、数据位置、工作负载间的干扰及最后时限。</p>
<p>亲和性：指定运行pod节点。</p>
<p>反亲和：不指定运行pod节点。</p>
</li>
<li><p>kube-controller-manager<br>kube-controller-manager是控制平面的组件，负责运行控制器进程。从逻辑上讲，每个控制器都是一个单独的进程，但是为了降低复杂性，它们都被编译到同一个可执行文件，并在同一个进程中运行。<br>这些控制器包括:</p>
<ul>
<li>节点控制器(Node Controller):负责在节点出现故障时进行通知和响应。</li>
<li>任务控制器(Job Controller)︰监测代表一次性任务的Job对象，然后创建Pods 来运行这些任务直至完成。 </li>
<li>端点分片控制器（Endpointslice controller)∶填充端点分片（EndpointSlice)对象（以提供Service和 Pod之间的链接)。</li>
<li>服务账号控制器（ServiceAccount controller)︰为新的命名空间创建默认的服务账号(ServiceAccount)。</li>
</ul>
</li>
<li><p>cloud-controller-manager (<code>optional可选</code>)</p>
<p>一个Kubernetes 控制平面组件，嵌入了特定于云平台的控制逻辑。云控制器管理器(Cloud Controller Manager)允许你将你的集群连接到云提供商的API 之上，并将与该云平台交互的组件同与你的集群交互的组件分离开来。cloud-controller-manager仅运行特定于云平台的控制器。因此如果你在自己的环境中运行 Kubernetes，或者在本地计算机中运行学习环境，所部署的集群不需要有云控制器管理器。与kube-controller-manager类似, cloud-controllermanager将若干逻辑上独立的控制回路组合到同一个可执行文件中，供你以同一进程的方式运行。你可以对其执行水平扩容（运行不止一个副本)以提升性能或者增强容错能力。<br>下面的控制器都包含对云平台驱动的依赖:</p>
<ul>
<li>节点控制器(Node Controller)∶用于在节点终止响应后检查云提供商以确定节点是否已被删除 。</li>
<li>路由控制器(Route Controller):用于在底层云基础架构中设置路由。</li>
<li>服务控制器(Service Controller)︰用于创建、更新和删除云提供商负载均衡器。</li>
</ul>
</li>
</ul>
<h4 id="1-2-Node-组件"><a href="#1-2-Node-组件" class="headerlink" title="1.2 Node 组件"></a>1.2 Node 组件</h4><blockquote>
<p>节点组件会在每个节点上运行，负责维护运行的Pod并提供Kubernetes运行环境。</p>
</blockquote>
<ul>
<li><p>kubelet<br>kubelet会在集群中每个节点（node)上运行。它保证容器（containers）都运行在Pods 中。<br>kubelet 接收一组通过各类机制提供给它的 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。kubelet 不会管理不是由Kubernetes创建的容器。</p>
</li>
<li><p>kube-proxy<br>kube-proxy是集群中每个节点(node)上所运行的网络代理，实现 Kubernetes服务(Service)概念的一部分。</p>
<p>kube-proxy维护节点上的一些网络规则，这些网络规则会允许从集群内部或外部的网络会话与Pod进行网络通信。<br>如果操作系统提供了可用的数据包过滤层，则 kube-proxy 会通过它来实现网络规则。否则，kube-proxy 仅做流量转发。</p>
</li>
<li><p>容器运行时(Container Runtime)<br>容器运行环境是负责运行容器的软件。<br>Kubernetes支持许多容器运行环境，例如containerd、CRI-0、Docker以及Kubernetes CRI 的其他任何实现。</p>
</li>
</ul>
<h4 id="1-3-插件-Addons"><a href="#1-3-插件-Addons" class="headerlink" title="1.3 插件(Addons)"></a>1.3 插件(Addons)</h4><ul>
<li>DNS<br>尽管其他插件都并非严格意义上的必需组件，但几乎所有Kubernetes集群都应该有集群DNS因为很多示例都需要DNS服务。</li>
<li>Web 界面(仪表盘)<br>Dashboard 是Kubernetes 集群的通用的、基于Web的用户界面。它使用户可以管理集群中运行的应用程序以及集群本身，并进行故障排除。</li>
<li>容器资源监控<br>容器资源监控将关于容器的一些常见的时间序列度量值保存到一个集中的数据库中，并提供浏览这些数据的界面。</li>
<li>集群层面日志<br>集群层面日志机制负责将容器的日志数据保存到一个集中的日志存储中，这种集中日志存储提供搜索和浏览接口。</li>
</ul>
<h3 id="2、集群架构详细"><a href="#2、集群架构详细" class="headerlink" title="2、集群架构详细"></a>2、集群架构详细</h3><img src="/posts/1160991310/image-20230210221416527.png" class="" title="image-20230210221416527">

<ul>
<li>总结<br>Kubernetes 集群由多个节点组成，节点分为两类:一类是属于管理平面的主节点/控制节点(Master Node);一类是属于运行平面的工作节点(Worker Node)。显然，复杂的工作肯定都交给控制节点去做了，工作节点负责提供稳定的操作接口和能力抽象即可。</li>
</ul>
<h3 id="3、集群搭建-重点"><a href="#3、集群搭建-重点" class="headerlink" title="3、集群搭建[重点]"></a>3、集群搭建[重点]</h3><ul>
<li>minikube<br>只是一个K8S集群模拟器，只有一个节点的集群，只为测试用，master和 worker都在一起。</li>
<li>裸机安装<br>至少需要两台机器（主节点、曩作节点个一台)，需要自己安装Kubernetes组件，配置会稍微麻烦点。缺点:配置麻烦,缺少生态支持，例如负载均衡器、云存储。</li>
<li>直接用云平台Kubernetes<br>可视化搭建,只需简单几步就可以创建好一个集群。<br>优点∶安装简单，生态齐全，负载均衡器、存储等都给你配套好，简单操作就搞定</li>
<li>k3s<br>安装简单，脚本自动完成。<br>优点:轻量级，配置要求低，安装简单，生态齐全。</li>
</ul>
<h4 id="3-2-裸机安装"><a href="#3-2-裸机安装" class="headerlink" title="3.2 裸机安装"></a>3.2 裸机安装</h4><h5 id="θ、环境准备"><a href="#θ、环境准备" class="headerlink" title="θ、环境准备"></a>θ、环境准备</h5><ul>
<li>节点数量: 3台虚拟机 centos7</li>
<li>硬件配置: 2G或更多的RAM, 2个CPU或更多的CPU, 硬盘至少30G以上</li>
<li>网络要求:多个节点之间网络互通，每个节点能访问外网</li>
</ul>
<h5 id="1、集群规划"><a href="#1、集群规划" class="headerlink" title="1、集群规划"></a>1、集群规划</h5><ul>
<li>k8s-node1: 192.168.58.150</li>
<li>k8s-node2: 192.168.58.151</li>
<li>k8s-node3: 192.168.58.152</li>
</ul>
<h5 id="2、设置主机名称"><a href="#2、设置主机名称" class="headerlink" title="2、设置主机名称"></a>2、设置主机名称</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置主机名称</span></span><br><span class="line">$ hostnamectl set-hostname k8s-n1</span><br><span class="line">$ hostnamectl set-hostname k8s-n2</span><br><span class="line">$ hostnamectl set-hostname k8s-n3</span><br><span class="line"><span class="comment"># 查看设置的主机名称</span></span><br><span class="line">$ hostname</span><br></pre></td></tr></table></figure>

<h5 id="3、同步hosts文件"><a href="#3、同步hosts文件" class="headerlink" title="3、同步hosts文件"></a>3、同步hosts文件</h5><blockquote>
<p>如果 DNS 不支持主机名称解析，还需要在每台机器的 /etc/hosts 文件中添加主机名和 IP 的对应关系:</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.58.150 k8s-n1</span></span><br><span class="line"><span class="string">192.168.58.151 k8s-n2</span></span><br><span class="line"><span class="string">192.168.58.152 k8s-n3</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>查看配置的 hosts 的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /etc/hosts</span><br></pre></td></tr></table></figure>

<h5 id="4、关闭防火墙"><a href="#4、关闭防火墙" class="headerlink" title="4、关闭防火墙"></a>4、关闭防火墙</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>

<h5 id="5、关闭swap分区"><a href="#5、关闭swap分区" class="headerlink" title="5、关闭swap分区"></a>5、关闭swap分区</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ swapoff -a &amp;&amp; sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<h5 id="6、同步时间"><a href="#6、同步时间" class="headerlink" title="6、同步时间"></a>6、同步时间</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install ntpdate -y</span><br><span class="line">$ ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h5 id="7、安装-containerd"><a href="#7、安装-containerd" class="headerlink" title="7、安装 containerd"></a>7、安装 containerd</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 yum-config-manager 相关依赖</span></span><br><span class="line">$ yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># 添加 containerd yum 源</span></span><br><span class="line">$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 安装 containerd</span></span><br><span class="line">$ yum install -y containerd.io cri-tools</span><br><span class="line"><span class="comment"># 配置 containerd(设置镜像，默认从 dockerhub 拉取镜像)</span></span><br><span class="line">$ <span class="built_in">cat</span> &gt; /etc/containerd/config.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">disabled_plugins = [&quot;restart&quot;]</span></span><br><span class="line"><span class="string">[plugins.linux]</span></span><br><span class="line"><span class="string">shim_debug = true</span></span><br><span class="line"><span class="string">[plugins.cri.registry.mirrors.&quot;docker.io&quot;]</span></span><br><span class="line"><span class="string">endpoint = [&quot;https://frz7i079.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">[plugins.cri]</span></span><br><span class="line"><span class="string">sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.2&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 启动 containerd 服务 并 开机配置自启动</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> containerd &amp;&amp; systemctl start containerd &amp;&amp; systemctl status containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 containerd 网络配置</span></span><br><span class="line">$ <span class="built_in">cat</span> &gt;/etc/modules-load.d/containerd.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 k8s 网络配置</span></span><br><span class="line">$ <span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载 overlay br_netfilter模块; </span></span><br><span class="line">$ modprobe overlay</span><br><span class="line">$ modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前配置是否生效</span></span><br><span class="line">$ sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="8、添加源"><a href="#8、添加源" class="headerlink" title="8、添加源"></a>8、添加源</h5><h5 id="查看源"><a href="#查看源" class="headerlink" title="查看源"></a>查看源</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum repolist</span><br></pre></td></tr></table></figure>

<p>添加源</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo-gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://minrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kUbernetes/yum/dc/pm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mv</span> kubernetes.repo /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看源</span></span><br><span class="line">$ yum repolist</span><br></pre></td></tr></table></figure>

<h5 id="9、安装-K8S"><a href="#9、安装-K8S" class="headerlink" title="9、安装 K8S"></a>9、安装 K8S</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装最新版本</span></span><br><span class="line"><span class="comment"># $ yum install -y kubelet kubeadm kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定版本安装(推荐安装)</span></span><br><span class="line">$ yum install -y kubelet-1.26.0 kubectl-1.26.0 kubeadm-1.26.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动kubelet(这个地方启动两遍，否则启动不成功？)</span></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> kubelet &amp;&amp; sudo systemctl start kubelet &amp;&amp; sudo systemctl status kubelet</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="10、初始化集群"><a href="#10、初始化集群" class="headerlink" title="10、初始化集群"></a>10、初始化集群</h5><p><code>注意:初始化k8s集群仅仅需要再在master节点进行集群初始化!</code></p>
<ul>
<li>apiserver-advertise-address：master节点IP地址</li>
<li>pod-network-cidr：pod 内部节点的IP地址，这个随便填</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init \</span><br><span class="line">--apiserver-advertise-address=192.168.58.150 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost network-scripts]<span class="comment"># kubeadm init \</span></span><br><span class="line">&gt; --apiserver-advertise-address=192.168.58.150 \</span><br><span class="line">&gt; --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">&gt; --image-repository registry.aliyuncs.com/google_containers</span><br><span class="line">[init] Using Kubernetes version: v1.26.1</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">[certs] Using certificateDir folder <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line">[certs] Generating <span class="string">&quot;ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver&quot;</span> certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [k8s-n1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.58.150]</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/server&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [k8s-n1 localhost] and IPs [192.168.58.150 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [k8s-n1 localhost] and IPs [192.168.58.150 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;sa&quot;</span> key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[control-plane] Using manifest folder <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span><br><span class="line">[etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="built_in">local</span> etcd <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 11.013612 seconds</span><br><span class="line">[upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node k8s-n1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node k8s-n1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: x7zuw6.3el9y6durh1lfzim</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstrap-token] Creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line">[kubelet-finalize] Updating <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.58.150:6443 --token x7zuw6.3el9y6durh1lfzim \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:7cbe76c641f797456bb6cccea6affac6606efc4c5f7656f5b709aef205ba9166 </span><br><span class="line">[root@localhost network-scripts]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h5 id="11、执行-master-节点配置"><a href="#11、执行-master-节点配置" class="headerlink" title="11、执行 master 节点配置"></a>11、执行 master 节点配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<h5 id="12、查看-节点信息"><a href="#12、查看-节点信息" class="headerlink" title="12、查看 节点信息"></a>12、查看 节点信息</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost network-scripts]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS     ROLES           AGE     VERSION</span><br><span class="line">k8s-n1   NotReady   control-plane   5m22s   v1.26.0</span><br><span class="line">[root@localhost network-scripts]<span class="comment"># kubectl get pods -A</span></span><br><span class="line">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-5bbd96d687-rrsvs         0/1     Pending   0          6m25s</span><br><span class="line">kube-system   coredns-5bbd96d687-wftbq         0/1     Pending   0          6m25s</span><br><span class="line">kube-system   etcd-k8s-n1                      1/1     Running   0          6m37s</span><br><span class="line">kube-system   kube-apiserver-k8s-n1            1/1     Running   0          6m37s</span><br><span class="line">kube-system   kube-controller-manager-k8s-n1   1/1     Running   0          6m37s</span><br><span class="line">kube-system   kube-proxy-gg65t                 1/1     Running   0          6m25s</span><br><span class="line">kube-system   kube-scheduler-k8s-n1            1/1     Running   0          6m40s</span><br><span class="line">[root@localhost network-scripts]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h5 id="13、在其他两个节点执行-加入到主节点的操作"><a href="#13、在其他两个节点执行-加入到主节点的操作" class="headerlink" title="13、在其他两个节点执行 加入到主节点的操作"></a>13、在其他两个节点执行 加入到主节点的操作</h5><p>1、首先在主节点上监控集群节点。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群节点，一秒钟执行一次</span></span><br><span class="line">[root@localhost network-scripts]<span class="comment"># watch -n 1 kubectl get nodes</span></span><br></pre></td></tr></table></figure>

<p>2、node节点执行加入主节点的操作</p>
<p><code>这句话在初始化主节点的时候，自动生成的</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm <span class="built_in">join</span> 192.168.58.150:6443 --token x7zuw6.3el9y6durh1lfzim \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:7cbe76c641f797456bb6cccea6affac6606efc4c5f7656f5b709aef205ba9166 </span><br></pre></td></tr></table></figure>

<p>3、主节点监控结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Every 1.0s: kubectl get nodes                                                                       Sun Feb 12 10:10:16 2023</span><br><span class="line"></span><br><span class="line">NAME     STATUS     ROLES           AGE   VERSION</span><br><span class="line">k8s-n1   NotReady   control-plane   12m   v1.26.0</span><br><span class="line">k8s-n2   NotReady   &lt;none&gt;          71s   v1.26.0</span><br><span class="line">k8s-n3   NotReady   &lt;none&gt;          48s   v1.26.0</span><br></pre></td></tr></table></figure>

<h5 id="14、配置集群网络"><a href="#14、配置集群网络" class="headerlink" title="14、配置集群网络"></a>14、配置集群网络</h5><p>1、再次查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pods -A</span></span><br><span class="line">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-5bbd96d687-rrsvs         0/1     Pending   0          15m</span><br><span class="line">kube-system   coredns-5bbd96d687-wftbq         0/1     Pending   0          15m</span><br><span class="line">kube-system   etcd-k8s-n1                      1/1     Running   0          15m</span><br><span class="line">kube-system   kube-apiserver-k8s-n1            1/1     Running   0          15m</span><br><span class="line">kube-system   kube-controller-manager-k8s-n1   1/1     Running   0          15m</span><br><span class="line">kube-system   kube-proxy-5dmqm                 1/1     Running   0          4m13s</span><br><span class="line">kube-system   kube-proxy-gg65t                 1/1     Running   0          15m</span><br><span class="line">kube-system   kube-proxy-jx486                 1/1     Running   0          4m36s</span><br><span class="line">kube-system   kube-scheduler-k8s-n1            1/1     Running   0          15m</span><br></pre></td></tr></table></figure>

<p>2、配置集群网络解决</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 kube-flannel 文件，将下面的内容拷贝进去</span></span><br><span class="line">vim kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>文件内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/enforce:</span> <span class="string">privileged</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni-plugin</span></span><br><span class="line">       <span class="comment">#image: flannelcni/flannel-cni-plugin:v1.1.0 for ppc64le and mips64le (dockerhub limitations may apply)</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/cni/bin/flannel</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">       <span class="comment">#image: flannelcni/flannel:v0.19.0 for ppc64le and mips64le (dockerhub limitations may apply)</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel:v0.19.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">       <span class="comment">#image: flannelcni/flannel:v0.19.0 for ppc64le and mips64le (dockerhub limitations may apply)</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel:v0.19.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EVENT_QUEUE_DEPTH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;5000&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>

<p>执行配置，<code>只在主节点上执行就行</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl apply -f kube-flannel.yml</span></span><br><span class="line">namespace/kube-flannel created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-ds created</span><br></pre></td></tr></table></figure>



<h2 id="第三章-Pod-amp-Container"><a href="#第三章-Pod-amp-Container" class="headerlink" title="第三章 Pod &amp; Container"></a>第三章 Pod &amp; Container</h2><ul>
<li><p>什么是 Pod</p>
</li>
<li><p>Pod基本操作</p>
</li>
<li><p>Pod 的 Labels</p>
</li>
<li><p>Pod 的生命周期</p>
</li>
<li><p>container 特性 </p>
</li>
<li><p>Pod 的资源限制.</p>
</li>
<li><p>Pod中Init容器</p>
</li>
<li><p>节点亲和性分配 Pod</p>
</li>
</ul>
<h3 id="1、什么是Pod"><a href="#1、什么是Pod" class="headerlink" title="1、什么是Pod"></a>1、什么是Pod</h3><blockquote>
<p>摘取官网: <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/#working-with-pods">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/#working-with-pods</a></p>
</blockquote>
<h4 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h4><p>Pod 是可以在 Kubernetes 中<code>创建和管理的、最小的可部署的计算单元</code>。<code>Pod(就像在鲸鱼英或者豌豆萸中）是一组（一个或多个）容器</code>；这些容器共享存储、网络、以及怎样运行这些容器的声明。<code>Pod 中的内容总是并置(colocated)的并且一同调度，在共享的上下文中运行</code>。简言之如果用Docker的术语来描述。Pod类似于共享名字空间并共享文件系统卷的一组容器。</p>
<p><code>定义:Pod就是用来管理一组(一个I多个)容器的集合特点∶共享网络共享存储共享上下文环境。</code></p>
<h4 id="1-2-Pod怎样管理多个容器"><a href="#1-2-Pod怎样管理多个容器" class="headerlink" title="1.2 Pod怎样管理多个容器?"></a>1.2 Pod怎样管理多个容器?</h4><p>Pod 中的容器被自动安排到集群中的同一物理机或虚拟机上，并可以一起进行调度。容器之间可以共享资源和依赖、彼此通信、协调何时以及何种方式终止自身。例如，你可能有一个容器，为共享卷中的文件提供Web服务器支持，以及一个单独的“边车(sidercar)”容器负责从远端更新这些文件，如下图所示:</p>
<img src="/posts/1160991310/image-20230212105618568.png" class="" title="image-20230212105618568">

<h4 id="1-3-如何使用Pod"><a href="#1-3-如何使用Pod" class="headerlink" title="1.3 如何使用Pod?"></a>1.3 如何使用Pod?</h4><p>通常你不需要直接创建Pod，甚至单实例 Pod。相反，你会使用诸如 Deployment 或 Job 这类工作负载资源来创建 Pod。如果Pod 需要跟踪状态，可以考虑StatefulSet资源。</p>
<p>Kubernetes集群中的Pod主要有两种用法:</p>
<ul>
<li>运行单个容器的 Pod。”每个 Pod 一个容器” 模型是最常见的 Kubernetes 用例；在这种情况下，可以将 Pod 看作单个容器的包装器，并且 Kubernetes 直接管理Pod，而不是容器。</li>
<li>运行多个协同工作的容器的 Pod。Pod 可能封装由多个紧密耦合且需要共享资源的共处容器组成的应用程序。这些位于同一位置的容器可能形成单个内聚的服务单元——个容器将文件从共享卷提供给公众，而另一个单独的 “边车”(sidecar)容器则刷新或更新这些文件。Pod 将这些容器和存储资源打包为一个可管理的实体。</li>
</ul>
<p><code>说明</code>: </p>
<ul>
<li>将多个并置、同管的容器组织到一个Pod 中是一种相对高级的使用场景。只有在一些场景中，容器之间紧密关联时你才应该使用这种模式。</li>
<li>每个Pod都旨在运行给定应用程序的单个实例。如果希望横向扩展应用程序(例如，运行多个实例以提供更多的资源)，则应该使用多个Pod，每个实例使用一个 Pod。在Kubernetes 中，这通常被称为副本(Replication)。通常使用一种工作负载资源及其控制器来创建和管理一组Pod副本。</li>
</ul>
<h3 id="2、Pod-基本操作"><a href="#2、Pod-基本操作" class="headerlink" title="2、Pod 基本操作"></a>2、Pod 基本操作</h3><h4 id="2-1-查看-pod"><a href="#2-1-查看-pod" class="headerlink" title="2.1 查看 pod"></a>2.1 查看 pod</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看默认命名空间的pod</span></span><br><span class="line">$ kubectl get pods|pod|po</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定命名空间的pod</span></span><br><span class="line">$ kubectl get po -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有命名空间的pod(k8s创建完成之后默认存在 两个系统命名空间 default 和 kube-system)</span></span><br><span class="line">$ kubectl get pods|pod -A</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看默认命名空间下 pod 的详细信息</span></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有命名空间下pod 的详细信息</span></span><br><span class="line">$ kubectl get pods -o wide -A</span><br><span class="line"></span><br><span class="line"><span class="comment">#实时监控pod 的状态</span></span><br><span class="line">$ kubectl get pod -w</span><br></pre></td></tr></table></figure>

<h4 id="2-2-创建-pod"><a href="#2-2-创建-pod" class="headerlink" title="2.2 创建 pod"></a>2.2 创建 pod</h4><p><code>kubectl run nginx(pod名称) --image=nginx:1.19</code>：创建 pod ，这个方式不常用。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 pod,格式：kubectl run nginx(pod名称) --image=nginx:1.19</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl run nginx --image=nginx:1.19</span></span><br><span class="line">pod/nginx created</span><br><span class="line"><span class="comment"># 查看默认命名空间的 pod</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME    READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx   0/1     ContainerCreating   0          11s</span><br><span class="line"><span class="comment"># 查看所有命名空间的 pod</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pods -A</span></span><br><span class="line">NAMESPACE      NAME                             READY   STATUS    RESTARTS      AGE</span><br><span class="line">default        nginx                            1/1     Running   0             3m53s</span><br><span class="line">kube-flannel   kube-flannel-ds-f7svv            1/1     Running   0             25d</span><br><span class="line">kube-flannel   kube-flannel-ds-jf47b            1/1     Running   0             25d</span><br><span class="line">kube-flannel   kube-flannel-ds-tmd4f            1/1     Running   0             25d</span><br><span class="line">kube-system    coredns-5bbd96d687-rrsvs         1/1     Running   0             25d</span><br><span class="line">kube-system    coredns-5bbd96d687-wftbq         1/1     Running   0             25d</span><br><span class="line">kube-system    etcd-k8s-n1                      1/1     Running   0             25d</span><br><span class="line">kube-system    kube-apiserver-k8s-n1            1/1     Running   0             25d</span><br><span class="line">kube-system    kube-controller-manager-k8s-n1   1/1     Running   1             25d</span><br><span class="line">kube-system    kube-proxy-5dmqm                 1/1     Running   0             25d</span><br><span class="line">kube-system    kube-proxy-gg65t                 1/1     Running   0             25d</span><br><span class="line">kube-system    kube-proxy-jx486                 1/1     Running   0             25d</span><br><span class="line">kube-system    kube-scheduler-k8s-n1            1/1     Running   1 (59m ago)   25d</span><br><span class="line"><span class="comment"># 查看 nginx 的详细信息</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl describe pod nginx</span></span><br><span class="line">。。。。。。。。。。。。。。</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  6m57s  default-scheduler  Successfully assigned default/nginx to k8s-n2</span><br><span class="line">  Normal  Pulling    6m56s  kubelet            Pulling image <span class="string">&quot;nginx:1.19&quot;</span></span><br><span class="line">  Normal  Pulled     6m28s  kubelet            Successfully pulled image <span class="string">&quot;nginx:1.19&quot;</span> <span class="keyword">in</span> 28.047719729s (28.047780632s including waiting)</span><br><span class="line">  Normal  Created    6m28s  kubelet            Created container nginx</span><br><span class="line">  Normal  Started    6m28s  kubelet            Started container nginx</span><br></pre></td></tr></table></figure>

<h4 id="2-3-使用声明式的方式创建-pod-常用"><a href="#2-3-使用声明式的方式创建-pod-常用" class="headerlink" title="2.3 使用声明式的方式创建 pod(常用)"></a>2.3 使用声明式的方式创建 pod(常用)</h4><p><code>将创建 pod 所需信息，放到配置文件中，使用配置文件来创建pod</code>。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/workload-resources/pod-v1/">https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/workload-resources/pod-v1/</a></p>
</blockquote>
<p>编辑pod的配置文件【首先需要安装 Kubernetes 插件，快捷键 kpod】</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 ~]<span class="comment"># cat create-pod-nginx.yml</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.19</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><code>使用kubectl apply/create-f创建pod</code></p>
<p>注意:create 仅仅是不存在时创建，如果已经存在则报错! apply 不存在创建，存在则更新配置。推荐使用apply!</p>
<blockquote>
<p>create </p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $ kubectl create -f nginx-pod.yml</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl create -f nginx-pod.yml</span></span><br><span class="line">pod/nginx created</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          39s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>apply（推荐）</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl apply -f nginx-pod.yml</span></span><br><span class="line">pod/nginx created</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          4s</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl apply -f nginx-pod.yml</span></span><br><span class="line">pod/nginx unchanged</span><br></pre></td></tr></table></figure>

<h4 id="2-4-删除-pod"><a href="#2-4-删除-pod" class="headerlink" title="2.4 删除 pod"></a>2.4 删除 pod</h4><p><code>kubectl delete pod pod名称</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除 pod</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl delete pod nginx</span></span><br><span class="line">pod <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE      NAME                             READY   STATUS    RESTARTS      AGE</span><br><span class="line">kube-flannel   kube-flannel-ds-f7svv            1/1     Running   0             25d</span><br><span class="line">kube-flannel   kube-flannel-ds-jf47b            1/1     Running   0             25d</span><br><span class="line">kube-flannel   kube-flannel-ds-tmd4f            1/1     Running   0             25d</span><br><span class="line">kube-system    coredns-5bbd96d687-rrsvs         1/1     Running   0             25d</span><br><span class="line">kube-system    coredns-5bbd96d687-wftbq         1/1     Running   0             25d</span><br><span class="line">kube-system    etcd-k8s-n1                      1/1     Running   0             25d</span><br><span class="line">kube-system    kube-apiserver-k8s-n1            1/1     Running   0             25d</span><br><span class="line">kube-system    kube-controller-manager-k8s-n1   1/1     Running   1             25d</span><br><span class="line">kube-system    kube-proxy-5dmqm                 1/1     Running   0             25d</span><br><span class="line">kube-system    kube-proxy-gg65t                 1/1     Running   0             25d</span><br><span class="line">kube-system    kube-proxy-jx486                 1/1     Running   0             25d</span><br><span class="line">kube-system    kube-scheduler-k8s-n1            1/1     Running   1 (66m ago)   25d</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p><code>kubectl delete -f pod.yml</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          3m31s</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl delete -f nginx-pod.yml</span></span><br><span class="line">pod <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br><span class="line">[root@k8s-n1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>2.5 使用 IDEA 中 k8s 插件 创建 pod</p>
<p>安装<code>Kubernetes</code> 插件，创建 pod.yml 文件，在文件中写 <code>kpod</code>，会自动生成 文档结构。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> </span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> </span><br><span class="line">      <span class="attr">image:</span> </span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<h4 id="2-5-进入-pod-中容器"><a href="#2-5-进入-pod-中容器" class="headerlink" title="2.5 进入 pod 中容器"></a>2.5 进入 pod 中容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意: 这种方式进入容器默认只会进入 pod 中第一个容器</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx(pod名称) -- bash </span><br><span class="line"><span class="comment"># 进入指定容器</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it pod名称 -c 容器名称 -- bash </span><br><span class="line"><span class="comment"># 退出</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h4 id="2-6-查看-pod-的日志"><a href="#2-6-查看-pod-的日志" class="headerlink" title="2.6 查看 pod 的日志"></a>2.6 查看 pod 的日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：查看 pod 中第一个容器的日志</span></span><br><span class="line">$ kubectl logs -f(可选，实时显示) nginx（pod 名称）</span><br><span class="line"><span class="comment"># 注意：查看 pod 中指定容器的日志</span></span><br><span class="line">$ kubectl logs -f(可选，实时显示) nginx（pod 名称） -c nginx（容器名称）</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-7-查看pod的描述信息"><a href="#2-7-查看pod的描述信息" class="headerlink" title="2.7 查看pod的描述信息"></a>2.7 查看pod的描述信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod nginx(pod 名称)</span><br></pre></td></tr></table></figure>

<h3 id="3、Pod运行多个容器"><a href="#3、Pod运行多个容器" class="headerlink" title="3、Pod运行多个容器"></a>3、Pod运行多个容器</h3><h4 id="1-创建-pod，create-multi-pod-yml"><a href="#1-创建-pod，create-multi-pod-yml" class="headerlink" title="1 创建 pod，create-multi-pod.yml"></a>1 创建 pod，create-multi-pod.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.19</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">redis:5.0.10</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl apply -f mypod.yml </span></span><br><span class="line">pod/mypod created</span><br><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl get pod </span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">mypod   2/2     Running   0          70s</span><br></pre></td></tr></table></figure>

<h4 id="2-查看指定容器日志"><a href="#2-查看指定容器日志" class="headerlink" title="2 查看指定容器日志"></a>2 查看指定容器日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看日志(默认只查看第一个容器日志，这里是展示 nginx 日志)</span></span><br><span class="line">$ kubectl logs -f myapp</span><br><span class="line"><span class="comment"># 查看 pod 中指定容器的日志</span></span><br><span class="line">$ kubectl logs -f myapp-c nginx(容器名称)</span><br><span class="line">$ kubectl logs -f myapp-c redis(容器名称)</span><br></pre></td></tr></table></figure>

<h3 id="4、Pod-的-Labels-标签"><a href="#4、Pod-的-Labels-标签" class="headerlink" title="4、Pod 的 Labels(标签)"></a>4、Pod 的 Labels(标签)</h3><p>标签(Labels) 是附加到 Kubernetes 对象(比如 Pod)上的键值对。 标签旨在用于指定对用户有意义相关的对的标识属性。标签可以在创建时附加到对象，随后可以随时添加和修改。每个对象都可以定义一组键(key)/值(value)标签，但是每个键(key)对于给定对象必须是唯一的。</p>
<p>标签作用:就是用来给 k8s 中对象起别名，有了别名可以过滤和筛选。 </p>
<h4 id="1-语法"><a href="#1-语法" class="headerlink" title="1 语法"></a>1 语法</h4><p><code>标签由键值对组成</code> ，其有效标签值:</p>
<ul>
<li>必须为 63 个字符或更少 (可以为空)</li>
<li>除非标签值为空，必须以字母数字字符 (<code>[a-z0-9A-Z]</code>) 开头和结尾</li>
<li>包含破折号(<code>-</code>)、下划线(<code>_</code>)、点(<code>.</code>)和字母或效字</li>
</ul>
<h4 id="2-示例"><a href="#2-示例" class="headerlink" title="2 示例"></a>2 示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span> <span class="comment"># 创建时添加</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.19</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl apply -f myapp.yml </span></span><br><span class="line">pod/myapp created</span><br><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp   1/1     Running   0          14s</span><br><span class="line">mypod   2/2     Running   0          15m</span><br></pre></td></tr></table></figure>

<h4 id="3-标签的基本操作"><a href="#3-标签的基本操作" class="headerlink" title="3 标签的基本操作"></a>3 标签的基本操作</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看标签</span></span><br><span class="line">$ kubectl get pods --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态添加标签。 kubectL Label pod pod名称 标签键值对</span></span><br><span class="line">$ kubectl label pod myapp <span class="built_in">env</span>=prod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖标签 --overwrite</span></span><br><span class="line">$ kubectl label --overwrite pod myapp <span class="built_in">env</span>=<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 制除标签 -号代表制除标签</span></span><br><span class="line">$ kubectl label pod myapp <span class="built_in">env</span>-</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据标签筛选 env=test/env</span></span><br><span class="line">$ kubectl get po -l <span class="built_in">env</span>=<span class="built_in">test</span></span><br><span class="line">$ kubectl get po -l <span class="built_in">env</span></span><br><span class="line">$ kubectl get po -l !<span class="built_in">env</span>   <span class="comment"># 不包含的 pod</span></span><br><span class="line">$ kubectl get po -L <span class="built_in">env</span> <span class="keyword">in</span> (<span class="built_in">test</span>,prod)<span class="string">&#x27;#选择含有指定值的 pod</span></span><br><span class="line"><span class="string">$ kubectl get po -l env notin (test,prod)&#x27;</span> <span class="comment">#选择含有指定值的 pod</span></span><br></pre></td></tr></table></figure>

<h3 id="5、Pod的生命周期"><a href="#5、Pod的生命周期" class="headerlink" title="5、Pod的生命周期"></a>5、Pod的生命周期</h3><blockquote>
<p>摘自官网: <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/</a></p>
</blockquote>
<p>Pod 遵循预定义的生命周期，起始于 <code>Pending</code> 阶段， 如果至少其中有一个主要容器正常启动，则进入<code>Running</code> ，之后取决于 Pod 中是否有容器以失败状态结束而进入 <code>Succeeded</code> 或者 <code>Faled</code> 阶段。与此同时Pod 在其生命周期中只会被调度一次。一旦 Pod 被调度(分派)到某个节点，Pod会一直在该节点运行，直到 Pod 停止或者被终止。</p>
<h4 id="1-生命周期"><a href="#1-生命周期" class="headerlink" title="1 生命周期"></a>1 生命周期</h4><p>和一个个独立的应用容器一样，Pod 也被认为是相对临时性(而不是长期存在)的实体。 Pod 会被创建、赋予一个唯一的 ID(UID)， 并被调度到节点，并在终止(根据重启策略)或删除之前一直运行在该节点。如果一个节点死掉了，调度到该节点的 Pod 也被计划在给定超时期限结束后制除。</p>
<p>Pod 自身不具有自愈能力。如果 Pod 被调度到某节点而该节点之后失效， Pod 会被删除;类似地，Pod 无法在因节点资源耗尽或者节点维护而被驱逐期间继续存活。 Kubernetes 使用一种高级抽象来管理这些相对而言可随时丢弃的 Pod 实例， 称作控制器。</p>
<p>任何给定的 Pod (由 UID 定义)从不会被“重新调度(rescheduled)“到不的节点; 相反，这一 Pod 可以被一个新的、几乎完全相同的 Pod 暂换掉。如果需要，新 Pod 的名字可以不变，但是其 UID 会不同。</p>
<p>如果某物声称其生命期与某 Pod 相同，例如存储卷，这就意味着该对象在此 Pod (UID 亦相同)存在期间也一直存在。 如果 Pod 因为任何原因被删除，甚至某完全相同的替代 Pod 被创建时， 这个相关的对象(例如这里的卷)也会被删除并重建。</p>
<h4 id="2-Pod-阶段"><a href="#2-Pod-阶段" class="headerlink" title="2 Pod 阶段"></a>2 Pod 阶段</h4><p>Pod 阶段的数量和含义是严格定义的。 除了本文档中列举的内容外，不应该再假定 Pod 有其他的 <code>phase</code> 值。</p>
<table>
<thead>
<tr>
<th align="left">取值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Pending</code>（悬决）</td>
<td align="left">Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</td>
</tr>
<tr>
<td align="left"><code>Running</code>（运行中）</td>
<td align="left">Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。</td>
</tr>
<tr>
<td align="left"><code>Succeeded</code>（成功）</td>
<td align="left">Pod 中的所有容器都已成功终止，并且不会再重启。</td>
</tr>
<tr>
<td align="left"><code>Failed</code>（失败）</td>
<td align="left">Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</td>
</tr>
<tr>
<td align="left"><code>Unknown</code>（未知）</td>
<td align="left">因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>说明：</strong></p>
<p>1.当一个 Pod 被删除时，执行一些 kubectl 命令会展示这个 Pod 的状态为 <code>Terminating</code>（终止）。 这个 <code>Terminating</code> 状态并不是 Pod 阶段之一。 Pod 被赋予一个可以体面终止的期限，默认为 30 秒。 你可以使用 <code>--force</code> 参数来强制终止 Pod。</p>
<p>2.如果某节点死掉或者与集群中其他节点失联，Kubernetes 会实施一种策略，将失去的节点上运行的所有 Pod 的 <code>phase</code> 设置为 <code>Failed</code>。</p>
</blockquote>
<h3 id="6、Container特性"><a href="#6、Container特性" class="headerlink" title="6、Container特性"></a>6、Container特性</h3><h4 id="1-容器的生命周期"><a href="#1-容器的生命周期" class="headerlink" title="1 容器的生命周期"></a>1 容器的生命周期</h4><p>Kubernetes 会跟踪 Pod 中每个容器的状态，就像它跟踪 Pod 总体上的阶段一样。 你可以使用容器生命周期回调来在容器生命周期中的特定时间点触发事件。</p>
<p>一旦调度器将 Pod 分派给某个节点，<code>kubelet</code> 就通过容器运行时开始为 Pod 创建容器。容器的状态有三种：<code>Waiting</code>（等待）、<code>Running</code>（运行中）和 <code>Terminated</code>（已终止）。</p>
<p>要检查 Pod 中容器的状态，你可以使用 <code>kubectl describe pod &lt;pod 名称&gt;</code>。 其输出中包含 Pod 中每个容器的状态。</p>
<blockquote>
<p>每种状态都有特定的含义：</p>
</blockquote>
<p><code>Waiting</code> （等待）</p>
<p>如果容器并不处在 <code>Running</code> 或 <code>Terminated</code> 状态之一，它就处在 <code>Waiting</code> 状态。 处于 <code>Waiting</code> 状态的容器仍在运行它完成启动所需要的操作：例如， 从某个容器镜像仓库拉取容器镜像，或者向容器应用  Secret 数据等等。 当你使用 <code>kubectl</code> 来查询包含 <code>Waiting</code> 状态的容器的 Pod 时，你也会看到一个 Reason 字段，其中给出了容器处于等待状态的原因。</p>
<p><code>Running</code>（运行中）</p>
<p><code>Running</code> 状态表明容器正在执行状态并且没有问题发生。 如果配置了 <code>postStart</code> 回调，那么该回调已经执行且已完成。 如果你使用 <code>kubectl</code> 来查询包含 <code>Running</code> 状态的容器的 Pod 时， 你也会看到关于容器进入 <code>Running</code> 状态的信息。</p>
<p><code>Terminated</code>（已终止）</p>
<p>处于 <code>Terminated</code> 状态的容器已经开始执行并且或者正常结束或者因为某些原因失败。 如果你使用 <code>kubectl</code> 来查询包含 <code>Terminated</code> 状态的容器的 Pod 时， 你会看到容器进入此状态的原因、退出代码以及容器执行期间的起止时间。</p>
<p>如果容器配置了 <code>preStop</code> 回调，则该回调会在容器进入 <code>Terminated</code> 状态之前执行。</p>
<h4 id="2-容器生命周期回调-事件-钩子"><a href="#2-容器生命周期回调-事件-钩子" class="headerlink" title="2 容器生命周期回调/事件/钩子"></a>2 容器生命周期回调/事件/钩子</h4><p>类似于许多具有生命周期回调组件的编程语言框架，例如 Angular、VueKubernete 为容器提供了生命周期回调。 回调使容器能够了解其管理生命周期中的事件，并在执行相应的生命周期回调时运行在处理程序中实现的代码。</p>
<p>有两个回调暴露给容器:</p>
<ul>
<li><code>PostStat</code> 这个回调在容器被创建之后立即被执行。 但是，不能保证回调会在容器入口点ENTRYPOINT) 之前执行。没有参数传递给处理程序。</li>
<li><code>preStop</code> 在容器因 API请求或者管理事件诸如存活态探针、启动探针失败、资源抢占、资源竞争等) 而被终止之前，此回调会被调用。 如果容器已经处于已终止或者已完成状态，则对 preStop 回调的调用将失败。 在用来停止容器的 TERM 信号被发出之前，回调必须执行结束。 Pod 的终止宽限周期在 Prestop 回调被执行之前即开始计数， 所以无论回调函数的执行结果如何，容器最终都会在 Pod 的终止宽限期内被终止。 没有参数会被传递给处理程序。</li>
</ul>
<blockquote>
<p>使用容器生命周期回调</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lifecycle</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lifecycle</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.19</span></span><br><span class="line">      <span class="attr">lifecycle:</span></span><br><span class="line">        <span class="attr">postStart:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo postStart &gt;&gt; /start.txt&quot;</span>]</span><br><span class="line">        <span class="attr">preStop:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo postStart &gt;&gt; /stop.txt &amp;&amp; sleep 5&quot;</span>]</span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl exec -it lifecycle -c nginx -- bash</span></span><br><span class="line">root@lifecycle:/<span class="comment"># ls</span></span><br><span class="line">bin   dev                  docker-entrypoint.sh  home  lib64  mnt  proc  run   srv        sys  usr</span><br><span class="line">boot  docker-entrypoint.d  etc                   lib   media  opt  root  sbin  start.txt  tmp  var</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-容器重启策略"><a href="#3-容器重启策略" class="headerlink" title="3 容器重启策略"></a>3 容器重启策略</h4><p>Pod 的 <code>spec</code> 中包含一个 <code>restartPoliy</code> 字段，其可能取值包括</p>
<ul>
<li>Aways(总是重启)。</li>
<li>0nFalure(容器异常退出状态码非 ,重启)。</li>
<li>Never 。</li>
</ul>
<p>默认值是 ALways 。</p>
<p><code>restartPolcy</code> 适用于 Pod 中的所有容器。 <code>retartPolicy</code> 仅针对同-节点上 kubelet 的容器重启动作。当 Pod 中的容器退出时，kubelet会按指数回方式计算重启的延迟(10s、20s、40s…)，其最长延为 5 分钟 一旦某容执行  分钟并没有出现问题 kubeLet 对该容器的重启回退计时器执行重置操作。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.19</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<h4 id="4-自定义容器的启动命令"><a href="#4-自定义容器的启动命令" class="headerlink" title="4 自定义容器的启动命令"></a>4 自定义容器的启动命令</h4><p>和 Docker 容器一样,k8s中容器也可以通过command，args 用来修改容器启动默认执行命令以及传进相关参数。<code>但一般推荐使用 command 修改启动命令，使用 args 为启动命令传递参数</code>。</p>
<blockquote>
<p>默认</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">redis:5.0.10</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行</span></span><br><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl apply -f myredis.yml </span></span><br><span class="line">pod/redis created</span><br><span class="line"><span class="comment"># 进入容器内部查看</span></span><br><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl exec -it redis -c redis -- bash</span></span><br><span class="line">root@redis:/data<span class="comment"># ls</span></span><br><span class="line"><span class="comment"># 此时 data 文件为空</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 容器</span></span><br><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl delete pod redis</span></span><br><span class="line">pod <span class="string">&quot;redis&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<blockquote>
<p>添加启动命令，设置redis的启动方式 为appendonly </p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">redis:5.0.10</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动容器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl apply -f myredis.yml </span></span><br><span class="line">pod/redis created</span><br><span class="line">[root@k8s-n1 pod]<span class="comment"># kubectl exec -it redis -c redis -- bash</span></span><br><span class="line">root@redis:/data<span class="comment"># ls</span></span><br><span class="line">appendonly.aof</span><br><span class="line">root@redis:/data<span class="comment"># cat appendonly.aof </span></span><br><span class="line">root@redis:/data<span class="comment"># redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name zhangsan</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exit</span> </span><br><span class="line">root@redis:/data<span class="comment"># cat appendonly.aof </span></span><br><span class="line">*2</span><br><span class="line"><span class="variable">$6</span></span><br><span class="line">SELECT</span><br><span class="line"><span class="variable">$1</span></span><br><span class="line">0</span><br><span class="line">*3</span><br><span class="line"><span class="variable">$3</span></span><br><span class="line"><span class="built_in">set</span></span><br><span class="line"><span class="variable">$4</span></span><br><span class="line">name</span><br><span class="line"><span class="variable">$8</span></span><br><span class="line">zhangsan</span><br><span class="line">root@redis:/data<span class="comment"># </span></span><br></pre></td></tr></table></figure>



<h4 id="5-容器探针"><a href="#5-容器探针" class="headerlink" title="5 容器探针"></a>5 容器探针</h4><p><code>probe</code> 是由 kubelet 对容器执行的定期诊断。 要执行诊断，kubelet 可以在容器内执行代码，也可以发出一个网络请求。</p>
<p>定义：容器探针就是定期对容器进行健康检查的。</p>
<blockquote>
<p>探测类型</p>
</blockquote>
<p>针对运行中的容器， <code>kubelet</code> 可以选择是否执行以下三种探针，以及如何针对探测结果作出反应:</p>
<ul>
<li><p><code>livenessProbe</code> 指示容器是否正在运行。如果存活态探测失败，则 kubelet 会杀死容器， 并且容器将根据其重启策略决定未来。如果容器不提供存活探针，则默认状态为 Success 。</p>
</li>
<li><p><code>readinessProbe</code> 指示容是否准备好为请求提供服务。如果就绪态探测失败， 端点控制器将从与 Pod 配的所有服务的端点列表中制除该 Pod的 IP 地址。 初始延迟之前的就绪态的状态值默认为 Failure 。 如果容器不提供就绪态探针，则默认状态为Success。</p>
</li>
<li><p><code>startupProbe</code> 1.7+，指示容器中的应用是否已经启动。如果提供了启动探针，则所有其他探针都会被禁用，直到此探针成功为止。如果启动探测失败， kubelet 将杀死容器， 而容器依其重启策略进行重启。 如果容器没有提供启动探测，则默认状态为 Success。</p>
</li>
</ul>
<blockquote>
<p>探针机制</p>
</blockquote>
<p>使用探针来检查容器有四种不同的方法。 每个探针都必须准确定义为这四种机制中的一种:</p>
<ul>
<li><p>exec<br>在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功</p>
</li>
<li><p>grpc<br>使用RPC 执行一个远程过程调用。 目标应该实现 RPC健康检查。 如果响应的状态是“SERVING”，则认为诊断成功。 gRPC 探针是一个 pha特性，只有在你启用了“GRPCContainerProbe”特性门控时才能使用。</p>
</li>
<li><p>httpGet<br>对容器的IP 地址上指定端口和路径执行 HTTP GET 请求。如果应的状态码大于等于 20 且小于 00，则诊断被认为是成功的，</p>
</li>
<li><p>tcpSocket<br>对容器的P地址上的指定端口执行 TCP 检查如果端口打开，则诊断被认为是成功的。 如果远程系统(容器)在打开连接后立即将其关闭，这算作是健康的。</p>
</li>
</ul>
<blockquote>
<p>探针结果</p>
</blockquote>
<p>每次探测都将获得以下三种结果之一:</p>
<ul>
<li>Success    (成功)容器通过了诊断</li>
<li>Failure     (失败)容器未通过诊断。</li>
<li>Unknow   诊断失败，因此不会采取任何行动。</li>
</ul>
<blockquote>
<p>探针参数</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">initialDelaySeconds:</span> <span class="number">5</span> 	<span class="comment">#初始化时间5s</span></span><br><span class="line"><span class="attr">periodSeconds:</span> <span class="number">4</span>    	<span class="comment">#检测间隔时间4s</span></span><br><span class="line"><span class="attr">timeoutSeconds:</span> <span class="number">1</span>   	<span class="comment">#默认检测超时时间为1s</span></span><br><span class="line"><span class="string">failureThreshold:3</span>		<span class="comment">#默认失败次数为3次，达到3次后重启pod</span></span><br><span class="line"><span class="attr">successThreshold:</span> <span class="number">1</span>  	<span class="comment">#默认成功次数为1次，1次监测成功代表成功</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用探针</p>
</blockquote>
<p><code>exec</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">exec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.19</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">7</span><span class="string">;nginx</span> <span class="string">-g</span> <span class="string">&quot;daemon off;&quot;</span> <span class="comment">#这一步会和初始化同时开始运行，也就是在初始化5s后和7秒之间，会检测出一次失败，7秒后启动后检测正常，所以pod不会重启</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span>    <span class="comment">#这里使用 exec 执行 shell 命令检测容器状态</span></span><br><span class="line">        <span class="attr">command:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/run/nginx.pid</span>  <span class="comment">#查看是否有pid文件</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span>   <span class="comment">#初始化时间5s</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">4</span>    <span class="comment">#检测间隔时间4s</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span>   <span class="comment">#默认检测超时时间为1s</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span>   <span class="comment">#默认失败次数为3次，达到3次后重启pod</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>   <span class="comment">#默认成功次数为1次，1 次代表成功</span></span><br></pre></td></tr></table></figure>





























































</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://ericwjian.github.io">Eric</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ericwjian.github.io/posts/1160991310/">https://ericwjian.github.io/posts/1160991310/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ericwjian.github.io" target="_blank">Eric</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/K8S/">K8S</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3764913644/" title="OAuth2 使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">OAuth2 使用</div></div></a></div><div class="next-post pull-right"><a href="/posts/3072276713/" title="SpringBoot Actuator"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot Actuator</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Eric</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">140</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">98</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://gitee.com/wangjian_uuid" target="_blank" title="Gitee"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:358070983@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=358070983&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes"><span class="toc-text">Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%88%9D%E8%AF%86-Kubernetes"><span class="toc-text">第一章 初识 Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-k8s"><span class="toc-text">2、为什么需要 k8s</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81Kubernetes%EF%BC%8C%E5%AE%83%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-text">3、Kubernetes，它能做什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81Kubernetes-%E4%B8%8D%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">4、Kubernetes 不是什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E7%BB%84%E4%BB%B6-amp-%E6%9E%B6%E6%9E%84"><span class="toc-text">第二章 组件&amp;架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%9B%86%E7%BE%A4%E7%BB%84%E4%BB%B6"><span class="toc-text">1、集群组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%BB%84%E4%BB%B6-Control-Plane-Components"><span class="toc-text">1.1 控制平面组件(Control Plane Components)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Node-%E7%BB%84%E4%BB%B6"><span class="toc-text">1.2 Node 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%8F%92%E4%BB%B6-Addons"><span class="toc-text">1.3 插件(Addons)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E8%AF%A6%E7%BB%86"><span class="toc-text">2、集群架构详细</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-%E9%87%8D%E7%82%B9"><span class="toc-text">3、集群搭建[重点]</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E8%A3%B8%E6%9C%BA%E5%AE%89%E8%A3%85"><span class="toc-text">3.2 裸机安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%CE%B8%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">θ、环境准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="toc-text">1、集群规划</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E8%AE%BE%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0"><span class="toc-text">2、设置主机名称</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E5%90%8C%E6%AD%A5hosts%E6%96%87%E4%BB%B6"><span class="toc-text">3、同步hosts文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-text">4、关闭防火墙</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%E3%80%81%E5%85%B3%E9%97%ADswap%E5%88%86%E5%8C%BA"><span class="toc-text">5、关闭swap分区</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6%E3%80%81%E5%90%8C%E6%AD%A5%E6%97%B6%E9%97%B4"><span class="toc-text">6、同步时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7%E3%80%81%E5%AE%89%E8%A3%85-containerd"><span class="toc-text">7、安装 containerd</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8%E3%80%81%E6%B7%BB%E5%8A%A0%E6%BA%90"><span class="toc-text">8、添加源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%BA%90"><span class="toc-text">查看源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9%E3%80%81%E5%AE%89%E8%A3%85-K8S"><span class="toc-text">9、安装 K8S</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-text">10、初始化集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11%E3%80%81%E6%89%A7%E8%A1%8C-master-%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-text">11、执行 master 节点配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12%E3%80%81%E6%9F%A5%E7%9C%8B-%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-text">12、查看 节点信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13%E3%80%81%E5%9C%A8%E5%85%B6%E4%BB%96%E4%B8%A4%E4%B8%AA%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C-%E5%8A%A0%E5%85%A5%E5%88%B0%E4%B8%BB%E8%8A%82%E7%82%B9%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-text">13、在其他两个节点执行 加入到主节点的操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14%E3%80%81%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C"><span class="toc-text">14、配置集群网络</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-Pod-amp-Container"><span class="toc-text">第三章 Pod &amp; Container</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFPod"><span class="toc-text">1、什么是Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E7%AE%80%E4%BB%8B"><span class="toc-text">1.1 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Pod%E6%80%8E%E6%A0%B7%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-text">1.2 Pod怎样管理多个容器?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Pod"><span class="toc-text">1.3 如何使用Pod?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Pod-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">2、Pod 基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%9F%A5%E7%9C%8B-pod"><span class="toc-text">2.1 查看 pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA-pod"><span class="toc-text">2.2 创建 pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E4%BD%BF%E7%94%A8%E5%A3%B0%E6%98%8E%E5%BC%8F%E7%9A%84%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA-pod-%E5%B8%B8%E7%94%A8"><span class="toc-text">2.3 使用声明式的方式创建 pod(常用)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E5%88%A0%E9%99%A4-pod"><span class="toc-text">2.4 删除 pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E8%BF%9B%E5%85%A5-pod-%E4%B8%AD%E5%AE%B9%E5%99%A8"><span class="toc-text">2.5 进入 pod 中容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-%E6%9F%A5%E7%9C%8B-pod-%E7%9A%84%E6%97%A5%E5%BF%97"><span class="toc-text">2.6 查看 pod 的日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-%E6%9F%A5%E7%9C%8Bpod%E7%9A%84%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF"><span class="toc-text">2.7 查看pod的描述信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81Pod%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-text">3、Pod运行多个容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA-pod%EF%BC%8Ccreate-multi-pod-yml"><span class="toc-text">1 创建 pod，create-multi-pod.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97"><span class="toc-text">2 查看指定容器日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81Pod-%E7%9A%84-Labels-%E6%A0%87%E7%AD%BE"><span class="toc-text">4、Pod 的 Labels(标签)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%AF%AD%E6%B3%95"><span class="toc-text">1 语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%A4%BA%E4%BE%8B"><span class="toc-text">2 示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%A0%87%E7%AD%BE%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">3 标签的基本操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81Pod%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">5、Pod的生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">1 生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Pod-%E9%98%B6%E6%AE%B5"><span class="toc-text">2 Pod 阶段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81Container%E7%89%B9%E6%80%A7"><span class="toc-text">6、Container特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">1 容器的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%9E%E8%B0%83-%E4%BA%8B%E4%BB%B6-%E9%92%A9%E5%AD%90"><span class="toc-text">2 容器生命周期回调&#x2F;事件&#x2F;钩子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%B9%E5%99%A8%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-text">3 容器重启策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%B9%E5%99%A8%E7%9A%84%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">4 自定义容器的启动命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%AE%B9%E5%99%A8%E6%8E%A2%E9%92%88"><span class="toc-text">5 容器探针</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3346148432/" title="MyBatis 拦截器">MyBatis 拦截器</a><time datetime="2024-09-18T16:00:00.000Z" title="发表于 2024-09-19 00:00:00">2024-09-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3346148434/" title="MyBatis 集成druid数据源">MyBatis 集成druid数据源</a><time datetime="2024-09-18T16:00:00.000Z" title="发表于 2024-09-19 00:00:00">2024-09-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/1166366203/" title="SQL调优">SQL调优</a><time datetime="2024-07-16T16:00:00.000Z" title="发表于 2024-07-17 00:00:00">2024-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3109398172/" title="ContextHolder">ContextHolder</a><time datetime="2024-07-11T16:00:00.000Z" title="发表于 2024-07-12 00:00:00">2024-07-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/2889834893/" title="SpringCloud Feign">SpringCloud Feign</a><time datetime="2024-07-01T16:00:00.000Z" title="发表于 2024-07-02 00:00:00">2024-07-02</time></div></div></div></div></div></div></main><footer id="footer" style="background: #47577e"><div id="footer-wrap"><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '2N3fEF3CzNAzKwVbFlhSTUuM-gzGzoHsz',
      appKey: '9m41Klhi8IgsrNrbyMnoCHrN',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>